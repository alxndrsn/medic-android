<html>
<head>
	<title>medic-android test page</title>
	<script src="./pouchdb-6.0.7.min.js"></script>
	<script src="./jquery-3.1.1.min.js"></script>
	<style>
		#container { margin: auto 10px; }
		table { border: #999 solid 1px; }
		table tr:nth-child(even) { background-color: #ccc; }
		table td { padding: 2px }
	</style>
</head>
<body>
	<div id="container">
		<div>Status: <span id="current-status">Loading...</span></div>
		<div id="info">
			<h1>Info</h1>
			<table>
				<tr><td>info not loaded yet</td></tr>
			</table>
			<button class="update">Update</button>
		</div>
		<div id="doc-maker">
			<h1>Doc Maker</h1>
			<ol></ol>
			<button class="create">Create</button>
		</div>
	</div>
<script>
$(function() {
  function setStatus(status) {
    var statusMessage = '[' + new Date() + '] ' + status;
    console.log('Setting status message to: ' + statusMessage);
    $('#current-status').text(statusMessage);
  }

  var db = new PouchDB('test');

  function put(count) {
    return db.put({ _id:'generated-' + count })
      .then(function() {
        if(count) return put(count-1);
      })
      .catch(function(err) {
        setStatus('Error while putting doc number ' + count + ': ' + err);
      });
  }

  $('#info button.update').click(function() {
    setStatus('Updating info...');

    var $table = $('#info table');
    var appendRow = function() {
      var rows = '';
      var i = -1;
      while(++i < arguments.length) rows += '<td>' + arguments[i] + '</td>';
      $table.append('<tr>' + rows + '</tr>');
    }

    $table.empty();

    db.info()
      .then(function(result) {
        var keys = Object.keys(result);
        var i = keys.length;
        while(--i > 0) {
          var k = keys[i];
          var v = result[k];
          appendRow(k, v);
        }
      })
      .catch(function(err) {
        setStatus(err);
      });

    setStatus('Info updated');
  });
  $('#doc-maker button.create').click(function() {
    setStatus('Creating some docs in the DB...');

    put(10)
      .then(function() {
        setStatus('Docs created.');
      });
  });
  setStatus('loaded');
});
</script>
</body>
</html>
